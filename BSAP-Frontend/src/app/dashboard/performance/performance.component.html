<!-- Loading Spinner -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Loading performance data...</p>
</div>

<!-- Main Content -->
<div *ngIf="!loading" class="performance-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title1">
      <p class="page-title">BSAP-Field Report</p>
      <!-- <span><label>(Monyh/Year -</label> -->
      <span>({{ monthYear }})</span>
    </div>

    <div class="breadcrumb" *ngIf="currentModule && currentTopic">
      <div>
        <span class="breadcrumb-item1">Module - </span>
       
        <span class="breadcrumb-item active">{{
          currentModule.moduleName
        }}</span>
      </div>
      <div>
        <span class="breadcrumb-item1">Topic - </span>
        <span class="breadcrumb-item active">{{ currentTopic.topicName }}</span>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    {{ errorMessage }}
    <button class="close-btn" (click)="clearMessages()">&times;</button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
    <button class="close-btn" (click)="clearMessages()">&times;</button>
  </div>

  <!-- Form Container -->
  <div *ngIf="currentModule && currentTopic" class="form-container">
    <!-- Form Header Info -->

    <!-- Performance Form -->
    <form [formGroup]="performanceForm" class="performance-form">
      <!-- NORMAL Form Type -->
      <!-- NORMAL Form Type -->
      @if (currentTopic.formType === 'NORMAL') {
      <div class="normal-form">
        <h3 class="section-title">
          {{ currentTopic.topicSubName || currentTopic.topicName }}
        </h3>

        <div class="normal-table-container">
          <table class="normal-table">
            <thead>
              <tr>
                <th class="sr-no-header">Sr No</th>
                <th class="questions-header">Questions</th>

                <!-- Document-type handling -->
                @if (hasDocumentType()) {
                <th class="signed-pdf-header">Signed PDF</th>
                <th class="editable-word-header">Editable Word File</th>
                } @else { @if (hasPreviousQuestion()) {
                <th class="previous-header">Previous Month</th>
                }

                <th class="current-header">Current Month</th>

                @if (hasCumulativeQuestion()) {
                <th class="cumulative-header">Cumulative Month</th>
                } }
              </tr>
            </thead>

            <tbody>
              @for (question of currentTopic.questionDTOs; track question.id;
              let i = $index) {
              <tr class="normal-row">
                <td class="sr-no-cell">{{ i + 1 }}</td>
                <td class="question-cell">
                  <span
                    class="question-text"
                    [innerHTML]="formatQuestionText(question)"
                  ></span>
                </td>

            
                <!-- Document-type questions -->
                @if (isDocumentType(question)) {
                <td class="document-cell">
                  <input
                    type="file"
                    accept="application/pdf"
                    class="normal-input"
                    (change)="onFileSelect($event, 'pdf_' + question.id)"
                  />
                </td>

                <td class="document-cell">
                  <input
                    type="file"
                    accept=".doc,.docx"
                    class="normal-input"
                    (change)="onFileSelect($event, 'word_' + question.id)"
                  />
                </td>
                }
         
         

                @else if (question.type === 'DATE' &&
                shouldShowDateFields(question)) {
                <!-- Span across multiple columns -->
                <td [colSpan]="getDateFieldColspan()" class="date-fields-cell">
                  <div class="date-fields-container">
                    <div class="date-fields-grid">
                      @for (dateField of getDateFieldsArray(); track $index; let
                      dateIndex = $index) {
                      <div class="date-field-item">
                        <label class="date-label"
                          >Date {{ dateIndex + 1 }}:</label
                        >
                        <input
                          type="date"
                          class="date-input"
                          [formControlName]="
                            'date_' + question.id + '_' + dateIndex
                          "
                          [min]="previousMonthMin"
                          [max]="previousMonthMax"
                          placeholder="Select date"
                        />

                        @if (performanceForm.get('date_' + question.id + '_' +
                        dateIndex)?.invalid && performanceForm.get('date_' +
                        question.id + '_' + dateIndex)?.touched) {
                        <div class="error-message small-error">
                          Date {{ dateIndex + 1 }} is required
                        </div>
                        }
                      </div>
                      }
                    </div>
                    @if (hasDuplicateDates()) {
                    <div class="error-message">
                      Duplicate dates are not allowed. Please select different
                      dates for each Police Sabha.
                    </div>
                    }
                  </div>
                </td>
                }
                <!-- Numeric-type questions -->
                @else if (question.question.includes('No. of Police Sabha')) {
                @if (hasPreviousQuestion()) {
                <td class="previous-cell">
                  <input
                    type="text"
                    class="normal-input readonly"
                    [value]="question.previousCount || '0'"
                    readonly
                  />
                </td>
                }
                <td class="current-cell">
                  <input
                    type="number"
                    class="normal-input"
                    [formControlName]="'question_' + question.id"
                    [placeholder]="question.defaultVal"
                    [readonly]="question.isDisabled"
                    (input)="onPoliceSabhaCountChange($event, question.id)"
                  />
                </td>

                @if (hasCumulativeQuestion()) {
                <td class="cumulative-cell">
                  <input
                    type="text"
                    class="normal-input readonly"
                    [value]="getCumulativeValue(question)"
                    readonly
                  />
                </td>
                } }
                <!-- Numeric-type questions -->
                @else { @if (hasPreviousQuestion()) {
                <td class="previous-cell">
                  <input
                    type="text"
                    class="normal-input readonly"
                    [value]="question.previousCount || '0'"
                    readonly
                  />
                </td>
                }

                <td class="current-cell">
                  <input
                    type="number"
                    class="normal-input"
                    [formControlName]="'question_' + question.id"
                    [placeholder]="question.defaultVal"
                    [readonly]="question.isDisabled"
                  />
                </td>

                @if (hasCumulativeQuestion()) {
                <td class="cumulative-cell">
                  <input
                    type="text"
                    class="normal-input readonly"
                    [value]="getCumulativeValue(question)"
                    readonly
                  />
                </td>
                } }
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Error messages -->
        @for (question of currentTopic.questionDTOs; track question.id; let i =
        $index) { @if (performanceForm.get('question_' + question.id)?.invalid
        && performanceForm.get('question_' + question.id)?.touched) {
        <div class="error-message">
          Question {{ i + 1 }}: This field is required
        </div>
        } }
      </div>
      }

      <!-- Q/ST Form Type (Question-SubTopic Matrix) -->
      <div *ngIf="currentTopic.formType === 'Q/ST'" class="matrix-form">
        <h3 class="section-title">

          {{ currentTopic.topicSubName || currentTopic.topicName }}
        </h3>
        

        <div *ngIf="shouldShowCompanyFilter()" class="subtopic-filter">
          <label for="company-select" class="filter-label"
            >Select Company(One or more):</label
          >
          <select
            id="company-select"
            class="subtopic-select multiple"
            multiple
            size="4"
            (change)="onCompanySelect($event)"
          >
            <option
              *ngFor="let comp of company"
              [value]="comp.id"
              [selected]="isCompanySelected(comp.id)"
            >
              {{ comp.companyName }}
            </option>
          </select>
          <div class="filter-instructions">
            <small>Hold Ctrl (or Cmd on Mac) to select one or more company</small>
          </div>
          <div *ngIf="selectedSubTopics.length > 0" class="selection-count">
            {{ selectedSubTopics.length }} amenit{{
              selectedSubTopics.length === 1 ? "y" : "ies"
            }}
            selected
          </div>
          <div
            *ngIf="selectedSubTopics.length === 0 && shouldShowSubTopicFilter()"
            class="filter-hint"
          >
            Please select one or more companies to display the form
          

 <button 
    type="button" 
    class="btn btn-primary btn-sm"
    (click)="calculateStrengthTotals()"
    [disabled]="selectedCompanies.length === 0"
  > <i class="fas fa-calculator"></i> Calculate Strength Totals
  </button>
  <button 
    type="button" 
    class="btn btn-outline-primary btn-sm"
    (click)="navigateToStrengthTopic()"
  >
<i class="fas fa-arrow-right"></i> Go to Strength Summary
  </button>
  <small class="text-muted ms-2">
    Totals will be auto-filled in "Strength in all Coys" topic
  </small>
        </div>


        

       
        <div class="matrix-container" *ngIf="shouldShowCompanyFilter()">
          <div
            *ngFor="let compId of selectedCompanies"
            class="matrix-container"
          >
            <h3 class="company-title">Company: {{ getCompanyName(compId) }}</h3>

            <table class="matrix-table">
              <thead>
                <tr>
                  <th class="question-header">Questions</th>
                  <th
                    *ngFor="let subTopic of currentTopic.subTopics"
                    class="subtopic-header"
                  >
                    {{ subTopic.subTopicName }}
                  </th>
                </tr>
              </thead>

              <tbody>
                <tr
                  *ngFor="let question of currentTopic.questions; let i = index"
                >
                  <td class="question-cell">
                    <span class="question-number">{{ i + 1 }}.</span>
                    <span
                      class="question-text"
                      [innerHTML]="formatQuestionText(question)"
                    ></span>
                  </td>

                  <td
                    *ngFor="let subTopic of currentTopic.subTopics"
                    class="input-cell"
                  >
                    <!-- @if(isDocumentType(question)) {
                    <input
                      type="file"
                      accept=".pdf,.doc,.docx"
                      class="matrix-input"
                      (change)="onFileSelect($event, 'document_' + question.id + '_' + subTopic.id)"
                    /> -->
                    @if(isDocumentType(question)) {
                    <input
                      type="file"
                      accept="application/pdf"
                      class="matrix-input"
                      (change)="
                        onFileSelect(
                          $event,
                          'pdf_' + question.id + '_' + subTopic.id
                        )
                      "
                    />
                    }@else if (question.type=== 'DATE') {
                    <input
                      type="date"
                      class="matrix-input"
                      [formControlName]="
                        'matrix_' + question.id + '_' + subTopic.id
                      "
                      placeholder="Select date"
                    />
                    } @else{
                    <input
                      type="number"
                      class="matrix-input"
                      [formControlName]="
                        'matrix_' +
                        compId +
                        '_' +
                        question.id +
                        '_' +
                        subTopic.id
                      "
                      [class.calculated-field]="
                        isCalculatedField(question.id, subTopic.id)
                      "
                      placeholder="0"
                    />
                    }
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>


         <h4 class="preview-title">
    <i class="fas fa-chart-bar"></i>Strength in all Coys
  </h4>
  
  <div class="preview-container">
    <table class="preview-table">
      <thead>
        <tr>
          <th>Question</th>
          <th *ngFor="let subTopic of currentTopic?.subTopics">
            {{ subTopic.subTopicName }}
          </th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let question of getPreviewQuestions()">
          <td class="preview-question">
            <strong>{{ question.text }}</strong>
          </td>
          <td *ngFor="let subTopic of currentTopic?.subTopics" class="preview-value">
            {{ getPreviewValue(question.id, subTopic.id) }}
          </td>
          <td class="preview-total">
            <strong>{{ getQuestionTotal(question.id) }}</strong>
          </td>
        </tr>
        <!-- <tr class="preview-footer">
          <td><strong>Strength in all Coys</strong></td>
          <td *ngFor="let subTopic of currentTopic?.subTopics" class="preview-grand">
            <strong>{{ getSubTopicTotal(subTopic.id) }}</strong>
          </td>
          <td class="preview-grand-total">
            <strong>{{ getGrandTotal() }}</strong>
          </td>
        </tr> -->
      </tbody>
    </table>
    
    <div class="preview-summary">
      <div class="summary-item">
        <span class="summary-label">Total Companies:</span>
        <span class="summary-value">{{ selectedCompanies.length }}</span>
      </div>
      <!-- <div class="summary-item">
        <span class="summary-label">Next Step:</span>
        <span class="summary-value">
          Click "View Strength Summary" to see consolidated totals
        </span>
      </div> -->
    </div>
  </div>
    </div>


<!-- ... your existing company tables ... -->


<!-- </div> Closing div for matrix-form -->


        <div class="matrix-container" *ngIf="!shouldShowCompanyFilter()">
          <table class="matrix-table">
            <thead>
              <tr>
                <th class="question-header">Questions</th>
                <th
                  *ngFor="let subTopic of currentTopic.subTopics"
                  class="subtopic-header"
                >
                  {{ subTopic.subTopicName }}
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- <tr
                *ngFor="
                  let question of currentTopic.questions ||
                    currentTopic.questionDTOs;
                  let i = index
                "
                class="matrix-row"
              >
                <td class="question-cell">
                  <span class="question-number">{{ i + 1 }}.</span>
                  <span
                    class="question-text"
                    [innerHTML]="formatQuestionText(question)"
                  ></span>
                </td>
                <td
                  *ngFor="let subTopic of currentTopic.subTopics"
                  class="input-cell"
                >
                   @if(isDocumentType(question)) {
                  <input
                    type="file"
                    accept=".pdf,.doc,.docx"
                    class="matrix-input"
                    (change)="
                      onFileSelect(
                        $event,
                        'pdf_' + question.id + '_' + subTopic.id
                      )
                    "
                  />
                  }@else if (question.type=== 'DATE') {
                  <input
                    type="date"
                    class="matrix-input"
                    [formControlName]="
                      'matrix_' + question.id + '_' + subTopic.id
                    "
                    placeholder="Select date"
                  />
                  } @else{
                  <input
                    type="number"
                    class="matrix-input"
                    [formControlName]="
                      'matrix_' + question.id + '_' + subTopic.id
                    "
                    [class.calculated-field]="
                      isCalculatedField(question.id, subTopic.id)
                    "
                    placeholder="0"
                  />
                  }
                </td>
              </tr> -->
            
            
            <tr
  *ngFor="
    let question of currentTopic.questions ||
      currentTopic.questionDTOs;
    let i = index
  "
  class="matrix-row"
>
  <td class="question-cell">
    <span class="question-number">{{ i + 1 }}.</span>
    <span
      class="question-text"
      [innerHTML]="formatQuestionText(question)"
    ></span>
  </td>
  <td
    *ngFor="let subTopic of currentTopic.subTopics"
    class="input-cell"
  >
    @if(isDocumentType(question, subTopic)) {
      @if (isSignedPDFSubTopic(subTopic)) {
        <input
          type="file"
          accept="application/pdf"
          class="matrix-input"
          (change)="
            onFileSelect(
              $event,
              'pdf_' + question.id + '_' + subTopic.id
            )
          "
        />
      
      } @else if (isEditableWordSubTopic(subTopic)) {
        <input
          type="file"
          accept=".doc,.docx"
          class="matrix-input"
          (change)="
            onFileSelect(
              $event,
              'word_' + question.id + '_' + subTopic.id
            )
          "
        />
     
      } @else {
        <input
          type="file"
          accept=".pdf,.doc,.docx"
          class="matrix-input"
          (change)="
            onFileSelect(
              $event,
              'document_' + question.id + '_' + subTopic.id
            )
          "
        />
        <small class="hint-text">PDF or Word files</small>
      }
    } @else if (question.type === 'DATE') {
      <input
        type="date"
        class="matrix-input"
        [formControlName]="
          'matrix_' + question.id + '_' + subTopic.id
        "
        placeholder="Select date"
      />
    } @else {
      <input
        type="number"
        class="matrix-input"
        [formControlName]="
          'matrix_' + question.id + '_' + subTopic.id
        "
        [class.calculated-field]="
          isCalculatedField(question.id, subTopic.id)
        "
        placeholder="0"
      />
    }
  </td>
</tr>
            </tbody>
          </table>
        </div>

      </div>

      <!-- ST/Q Form Type (SubTopic-Question Matrix) -->
      <div *ngIf="currentTopic.formType === 'ST/Q'" class="matrix-form">
        <h3 class="section-title">
          {{ currentTopic.topicSubName || currentTopic.topicName }}
        </h3>

        <!-- SubTopic Filter Dropdown - Only for Earnings from monetized assets -->
        <!-- SubTopic Filter Dropdown - Multiple Selection -->
        <div *ngIf="shouldShowSubTopicFilter()" class="subtopic-filter">
          <label for="subtopic-select" class="filter-label"
            >Select(Multiple):</label
          >
          <select
            id="subtopic-select"
            class="subtopic-select multiple"
            multiple
            size="4"
            (change)="onSubTopicSelect($event)"
          >
            <option
              *ngFor="let subTopic of currentTopic.subTopics"
              [value]="subTopic.id"
              [selected]="isSubTopicSelected(subTopic.id)"
            >
              {{ subTopic.subTopicName }}
            </option>
          </select>
          <div class="filter-instructions">
            <small
              >Hold Ctrl (or Cmd on Mac) to select multiple</small
            >
          </div>
          <div *ngIf="selectedSubTopics.length > 0" class="selection-count">
            {{ selectedSubTopics.length }} amenit{{
              selectedSubTopics.length === 1 ? "y" : "ies"
            }}
            selected
          </div>
          <div
            *ngIf="selectedSubTopics.length === 0 && shouldShowSubTopicFilter()"
            class="filter-hint"
          >
            Please select one or more to display the form
          </div>

          <!-- Select All / None Buttons -->
          <div class="selection-actions" *ngIf="shouldShowSubTopicFilter()">
            <button
              type="button"
              class="btn btn-sm btn-outline"
              (click)="selectAllSubTopics()"
            >
              Select All
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline"
              (click)="clearAllSubTopics()"
            >
              Clear All
            </button>
          </div>
        </div>

        <div
          class="matrix-container"
          *ngIf="!shouldShowSubTopicFilter() || selectedSubTopics"
        >
          <table class="matrix-table">
            <thead>
              <tr>
                <th class="subtopic-header">
                  {{ getSubTopicHeader() }}
                </th>
                <th
                  *ngFor="
                    let question of currentTopic.questions ||
                      currentTopic.questionDTOs;
                    let i = index
                  "
                  class="question-header"
                >
                  {{ question.question }}
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- This will only show the selected subtopics -->
              <tr
                *ngFor="let subTopic of getSubTopicsToDisplay(); let i = index"
                class="matrix-row"
              >
                <td class="subtopic-cell">
                  {{ subTopic.subTopicName }}
                </td>
                <td
                  *ngFor="
                    let question of currentTopic.questions ||
                      currentTopic.questionDTOs
                  "
                  class="input-cell"
                >
                  <input
                    type="number"
                    class="matrix-input"
                    [formControlName]="
                      'matrix_' + question.id + '_' + subTopic.id
                    "
                    [class.calculated-field]="
                      isCalculatedField(question.id, subTopic.id)
                    "
                    placeholder="0"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Show message when no subtopic is selected for filtered topic -->
        <div
          *ngIf="shouldShowSubTopicFilter() && !hasSelectedSubTopics()"
          class="no-selection-container"
        >
          <div class="no-selection-message">
            <i class="fas fa-info-circle"></i>
            Please select one or more amenities from the dropdown above to
            display the form.
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <div class="navigation-buttons">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="navigatePrevious()"
            [disabled]="!prevNavInfo"
            [disabled]="!prevModule && !prevTopic"
          >
            <i class="fas fa-arrow-left"></i> Previous
          </button>

          <button
            type="button"
            class="btn btn-secondary"
            (click)="navigateNext()"
             [disabled]="!nextNavInfo"
            [disabled]="!nextModule && !nextTopic"
          >
            Next <i class="fas fa-arrow-right"></i>
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="goToPreviousModule()"
            [disabled]="!prevModule"
          >
            Previous Module <i class="fas fa-backward"></i>
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="goToNextModule()"
            [disabled]="!nextModule"
          >
            Next Module <i class="fas fa-forward"></i>
          </button>
        </div>

        <div class="form-buttons">
          <button
            type="button"
            class="btn btn-outline"
            (click)="saveForm()"
            [disabled]="saving"
          >
            <i class="fas fa-save"></i>
            {{ saving ? "Saving..." : "Save Draft" }}
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="submitForm()"
            [disabled]="saving || !performanceForm.valid"
          >
            <i class="fas fa-paper-plane"></i>
            {{ saving ? "Submitting..." : "Submit" }}
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Success State -->
  <div *ngIf="isSuccess" class="success-container">
    <div class="success-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <h3>Form Submitted Successfully!</h3>
    <p>Your performance statistics have been recorded.</p>
    <div class="success-actions">
      <button
        class="btn btn-primary"
        (click)="navigateNext()"
        *ngIf="nextModule || nextTopic"
      >
        Continue to Next
      </button>
      <button class="btn btn-outline" routerLink="/dashboard/homePage">
        Back to Dashboard
      </button>
    </div>
  </div>
</div>

<!-- OTP Verification Modal -->
<div *ngIf="showOTPModal" class="modal-overlay" (click)="closeOTPModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>OTP Verification</h3>
      <button class="close-btn" (click)="closeOTPModal()">&times;</button>
    </div>

    <div class="modal-body">
      <p>Please enter the 6-digit OTP sent to your registered mobile number:</p>

      <div class="otp-input-container">
        <input
          type="text"
          class="otp-input"
          [(ngModel)]="otpValue"
          placeholder="Enter OTP"
          maxlength="6"
          pattern="[0-9]{6}"
        />
      </div>

      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeOTPModal()">Cancel</button>
      <button
        class="btn btn-primary"
        (click)="verifyOTP()"
        [disabled]="!otpValue || otpValue.length !== 6 || saving"
      >
        {{ saving ? "Verifying..." : "Verify OTP" }}
      </button>
    </div>
  </div>
</div>

<!-- Auto-save Indicator -->
<div *ngIf="performanceForm?.dirty" class="auto-save-indicator">
  <i class="fas fa-clock"></i>
  Auto-saving...
</div>
